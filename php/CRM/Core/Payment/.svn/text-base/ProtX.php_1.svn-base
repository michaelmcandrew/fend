<?php

/*
 +--------------------------------------------------------------------+
 | CiviCRM version 2.2                                                |
 +--------------------------------------------------------------------+
 | Copyright CiviCRM LLC (c) 2004-2009                                |
 +--------------------------------------------------------------------+
 | This file is a part of CiviCRM.                                    |
 |                                                                    |
 | CiviCRM is free software; you can copy, modify, and distribute it  |
 | under the terms of the GNU Affero General Public License           |
 | Version 3, 19 November 2007.                                       |
 |                                                                    |
 | CiviCRM is distributed in the hope that it will be useful, but     |
 | WITHOUT ANY WARRANTY; without even the implied warranty of         |
 | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.               |
 | See the GNU Affero General Public License for more details.        |
 |                                                                    |
 | You should have received a copy of the GNU Affero General Public   |
 | License along with this program; if not, contact CiviCRM LLC       |
 | at info[AT]civicrm[DOT]org. If you have questions about the        |
 | GNU Affero General Public License or the licensing of CiviCRM,     |
 | see the CiviCRM license FAQ at http://civicrm.org/licensing        |
 +--------------------------------------------------------------------+
*/

/**
 *
 * @package CRM
 * @copyright CiviCRM LLC (c) 2004-2009
 * $Id$
 *
 */

require_once 'CRM/Core/Payment.php';

class CRM_Core_Payment_ProtX extends CRM_Core_Payment {
    const
        CHARSET  = 'iso-8859-1';

    protected $_mode = null;

    /**
     * Constructor
     *
     * @param string $mode the mode of operation: live or test
     *
     * @return void
     */
    function __construct( $mode, &$paymentProcessor ) {
        $this->_mode = $mode;

        $this->_paymentProcessor = $paymentProcessor;

        if ( $this->_paymentProcessor['payment_processor_type'] == 'PayPal_Standard' ) {
            return;
        }

        if ( ! $this->_paymentProcessor['user_name'] ) {
            CRM_Core_Error::fatal( ts( 'Could not find user name for payment processor' ) );
        }
    }

    /**
     * express checkout code. Check PayPal documentation for more information
     * @param  array $params assoc array of input parameters for this transaction
     *
     * @return array the result in an nice formatted array (or an error object)
     * @public
     */
    function setExpressCheckOut( &$params ) {
        $args = array( );

        $this->initialize( $args, 'SetExpressCheckout' );

        $args['paymentAction']  = $params['payment_action'];
        $args['amt']            = $params['amount'];
        $args['currencyCode']   = $params['currencyID'];
        $args['invnum']         = $params['invoiceID'];
        $args['returnURL'   ]   = $params['returnURL'];
        $args['cancelURL'   ]   = $params['cancelURL'];

        $result = $this->invokeAPI( $args );

        if ( is_a( $result, 'CRM_Core_Error' ) ) {
            return $result;
        }

        /* Success */
        return $result['token'];
    }

    /**
     * get details from paypal. Check PayPal documentation for more information
     *
     * @param  string $token the key associated with this transaction
     *
     * @return array the result in an nice formatted array (or an error object)
     * @public
     */
    function getExpressCheckoutDetails( $token ) {
        $args = array( );

        $this->initialize( $args, 'GetExpressCheckoutDetails' );
        $args['token'] = $token;

        $result = $this->invokeAPI( $args );

        if ( is_a( $result, 'CRM_Core_Error' ) ) {
            return $result;
        }

        /* Success */
        $params                           = array( );
        $params['token']                  = $result['token'];
        $params['payer_id'    ]           = $result['payerid'];
        $params['payer_status']           = $result['payerstatus'];
        $params['first_name' ]            = $result['firstname'];
        $params['middle_name']            = $result['middlename'];
        $params['last_name'  ]            = $result['lastname'];
        $params['street_address']         = $result['shiptostreet'];
        $params['supplemental_address_1'] = $result['shiptostreet2'];
        $params['city']                   = $result['shiptocity'];
        $params['state_province']         = $result['shiptostate'];
        $params['postal_code']            = $result['shiptozip'];
        $params['country']                = $result['shiptocountrycode'];

        return $params;
    }

    /**
     * do the express checkout at paypal. Check PayPal documentation for more information
     *
     * @param  string $token the key associated with this transaction
     *
     * @return array the result in an nice formatted array (or an error object)
     * @public
     */
    function doExpressCheckout( &$params ) {
        $args = array( );

        $this->initialize( $args, 'DoExpressCheckoutPayment' );

        $args['token']          = $params['token'];
        $args['paymentAction']  = $params['payment_action'];
        $args['amt']            = $params['amount'];
        $args['currencyCode']   = $params['currencyID'];
        $args['payerID']        = $params['payer_id'];
        $args['invnum']         = $params['invoiceID'];
        $args['returnURL'   ]   = $params['returnURL'];
        $args['cancelURL'   ]   = $params['cancelURL'];

        $result = $this->invokeAPI( $args );

        if ( is_a( $result, 'CRM_Core_Error' ) ) {
            return $result;
        }

        /* Success */
        $params['trxn_id']        = $result['transactionid'];
        $params['gross_amount'  ] = $result['amt'];
        $params['fee_amount'    ] = $result['feeamt'];
        $params['net_amount'    ] = $result['settleamt'];
        if ( $params['net_amount'] == 0 && $params['fee_amount'] != 0 ) {
            $params['net_amount'] = $params['gross_amount'] - $params['fee_amount'];
        }
        $params['payment_status'] = $result['paymentstatus'];
        $params['pending_reason'] = $result['pendingreason'];

        return $params;
    }

    function initialize( &$args, $method ) {
        $args['user'     ] = $this->_paymentProcessor['user_name' ];
        $args['pwd'      ] = $this->_paymentProcessor['password'  ];
        $args['version'  ] = 3.0;
        $args['signature'] = $this->_paymentProcessor['signature' ];
        $args['subject'  ] = $this->_paymentProcessor['subject'   ];
        $args['method'   ] = $method;
    }

    /**
     * This function collects all the information from a web/api form and invokes
     * the relevant payment processor specific functions to perform the transaction
     *
     * @param  array $params assoc array of input parameters for this transaction
     *
     * @return array the result in an nice formatted array (or an error object)
     * @public
     */
    function doDirectPayment( &$params ) {
        $args = array( );

        $this->initialize( $args, 'DoDirectPayment' );

        $args['paymentAction']  = $params['payment_action'];
        $args['amt']            = $params['amount'];
        $args['currencyCode']   = $params['currencyID'];
        $args['invnum']         = $params['invoiceID'];
        $args['ipaddress']      = $params['ip_address'];
        $args['creditCardType'] = $params['credit_card_type'];
        $args['acct']           = $params['credit_card_number'];
        $args['expDate']        = sprintf( '%02d', $params['month'] ) . $params['year'];
        $args['cvv2']           = $params['cvv2'];
        $args['firstName']      = $params['first_name'];
        $args['lastName']       = $params['last_name'];
        $args['email']          = $params['email'];
        $args['street']         = $params['street_address'];
        $args['city']           = $params['city'];
        $args['state']          = $params['state_province'];
        $args['countryCode']    = $params['country'];
        $args['zip']            = $params['postal_code'];
        $args['custom']         = CRM_Utils_Array::value( 'accountingCode',
                                                          $params );

        $result = $this->invokeAPI( $args );

        if ( is_a( $result, 'CRM_Core_Error' ) ) {
            return $result;
        }

        /* Success */
        $params['trxn_id']        = $result['transactionid'];
        $params['gross_amount'  ] = $result['amt'];
        return $params;
    }

    /**
     * This function checks to see if we have the right config values
     *
     * @return string the error message if any
     * @public
     */
    function checkConfig( ) {
        $error = array( );
        if ( $this->_paymentProcessor['payment_processor_type'] == 'PayPal_Standard' ||
             $this->_paymentProcessor['payment_processor_type'] == 'PayPal' ) {
            if ( empty( $this->_paymentProcessor['user_name'] ) ) {
                $error[] = ts( 'User Name is not set in the Administer CiviCRM &raquo; Payment Processor.' );
            }
        }

        if ( $this->_paymentProcessor['payment_processor_type'] != 'PayPal_Standard' ) {
            if ( empty( $this->_paymentProcessor['signature'] ) ) {
                $error[] = ts( 'Signature is not set in the Administer CiviCRM &raquo; Payment Processor.' );
            }

            if ( empty( $this->_paymentProcessor['password'] ) ) {
                $error[] = ts( 'Password is not set in the Administer CiviCRM &raquo; Payment Processor.' );
            }
        }

        if ( ! empty( $error ) ) {
            return implode( '<p>', $error );
        } else {
            return null;
        }
    }

    function cancelSubscriptionURL( ) {
        if ( $this->_paymentProcessor['payment_processor_type'] == 'PayPal_Standard' ) {
            return "{$this->_paymentProcessor['url_site']}cgi-bin/webscr?cmd=_subscr-find&alias=" .
                urlencode( $this->_paymentProcessor['user_name'] );
        } else {
            return null;
        }
    }

    /*************************************************************
      Send a post request with cURL
        $url = URL to send request to
        $data = POST data to send (in URL encoded Key=value pairs)
    *************************************************************/
    function requestPost($url, $data){
      // Set a one-minute timeout for this script
      set_time_limit(60);

      // Initialise output variable
      $output = array();

      // Open the cURL session
      $curlSession = curl_init();

      // Set the URL
      curl_setopt ($curlSession, CURLOPT_URL, $url);
      // No headers, please
      curl_setopt ($curlSession, CURLOPT_HEADER, 0);
      // It's a POST request
      curl_setopt ($curlSession, CURLOPT_POST, 1);
      // Set the fields for the POST
      curl_setopt ($curlSession, CURLOPT_POSTFIELDS, $data);
      // Return it direct, don't print it out
      curl_setopt($curlSession, CURLOPT_RETURNTRANSFER,1);
      // This connection will timeout in 30 seconds
      curl_setopt($curlSession, CURLOPT_TIMEOUT,30);
      //The next two lines must be present for the kit to work with newer version of cURL
      //You should remove them if you have any problems in earlier versions of cURL
        curl_setopt($curlSession, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt($curlSession, CURLOPT_SSL_VERIFYHOST, 1);

      //Send the request and store the result in an array

      $rawresponse = curl_exec($curlSession);
      //Store the raw response for later as it's useful to see for integration and understanding
      $_SESSION["rawresponse"]=$rawresponse;
      //Split response into name=value pairs
      $response = split(chr(10), $rawresponse);
      // Check that a connection was made
      if (curl_error($curlSession)){
        // If it wasn't...
        $output['Status'] = "FAIL";
        $output['StatusDetail'] = curl_error($curlSession);
      }

      // Close the cURL session
      curl_close ($curlSession);

      // Tokenise the response
      for ($i=0; $i<count($response); $i++){
        // Find position of first "=" character
        $splitAt = strpos($response[$i], "=");
        // Create an associative (hash) array with key/value pairs ('trim' strips excess whitespace)
        $output[trim(substr($response[$i], 0, $splitAt))] = trim(substr($response[$i], ($splitAt+1)));
      } // END for ($i=0; $i<count($response); $i++)

      // Return the output
      return $output;
    } // END function requestPost()

    function doTransferCheckout( &$params, $component = 'contribute' ) {

        /* For ProtX we have to do
           Post over to SagePay
           Get a response
           Then redirect
        */
        $config =& CRM_Core_Config::singleton( );

        if ( $component != 'contribute' && $component != 'event' ) {
            CRM_Core_Error::fatal( ts( 'Component is invalid' ) );
        }


        $notifyURL =
            $config->userFrameworkResourceURL .
            "extern/protXresult.php?reset=1&contactID={$params['contactID']}" .
            "&contributionID={$params['contributionID']}" .
            "&module={$component}";

    # Testing
        $notifyURL =
            "http://lcc.nfpservices.co.uk/sites/all/modules/civicrm/".
            "extern/protXresult.php?reset=1&contactID={$params['contactID']}" .
            "&contributionID={$params['contributionID']}" .
            "&module={$component}";

        if ( $component == 'event' ) {
            $notifyURL .= "&eventID={$params['eventID']}&participantID={$params['participantID']}";
        } else {
            $membershipID = CRM_Utils_Array::value( 'membershipID', $params );
            if ( $membershipID ) {
                $notifyURL .= "&membershipID=$membershipID";
            }
            $relatedContactID = CRM_Utils_Array::value( 'related_contact', $params );
            if ( $relatedContactID ) {
                $notifyURL .= "&relatedContactID=$relatedContactID";

                $onBehalfDupeAlert = CRM_Utils_Array::value( 'onbehalf_dupe_alert', $params );
                if ( $onBehalfDupeAlert ) {
                    $notifyURL .= "&onBehalfDupeAlert=$onBehalfDupeAlert";
                }
            }
        }

        $url    = ( $component == 'event' ) ? 'civicrm/event/register' : 'civicrm/contribute/transact';
        $cancel = ( $component == 'event' ) ? '_qf_Register_display'   : '_qf_Main_display';
        $returnURL = CRM_Utils_System::url( $url,
                                            "_qf_ThankYou_display=1&qfKey={$params['qfKey']}",
                                            true, null, false );
        $cancelURL = CRM_Utils_System::url( $url,
                                            "$cancel=1&cancel=1&qfKey={$params['qfKey']}",
                                            true, null, false );

        // ensure that the returnURL is absolute.
        if ( substr( $returnURL, 0, 4 ) != 'http' ) {
            CRM_Core_Error::fatal( ts( 'Sending a relative URL to PayPalIPN is erroneous. Please make your resource URL (in Administer CiviCRM >> Global Settings) absolute' ) );
        }

        $paypalParams =
            array( 'business'           => $this->_paymentProcessor['user_name'],
                   'notify_url'         => $notifyURL,
                   'item_name'          => $params['item_name'],
                   'quantity'           => 1,
                   'undefined_quantity' => 0,
                   'cancel_return'      => $cancelURL,
                   'no_note'            => 1,
                   'no_shipping'        => 1,
                   'return'             => $returnURL,
                   'rm'                 => 2,
                   'currency_code'      => $params['currencyID'],
                   'invoice'            => $params['invoiceID'] ,
                   'custom'             => CRM_Utils_Array::value( 'accountingCode',
                                                                   $params ) );

        $protxParams =
            array( 'Vendor'             => $this->_paymentProcessor['user_name'],
                   'NotificationURL'    => $notifyURL,
                   'Description'        => $params['item_name'],
                   'currency'           => $params['currencyID'],
                   'VendorTxCode'       => $params['invoiceID'] ,
                   'AllowGiftAid'       => 0,
                   'ApplyAVSCV2'        => 0,
                   'Apply3DSecure'      => 0,
                   'Profile'            => 'NORMAL',
                   'VPSProtocol'        => '2.23',
                   'TxType'             => 'PAYMENT',
                   'BillingCountry'     => 'GB',
                   'DeliveryCountry'    => 'GB'
                 );

        /*
        $otherVars = array( 'BillingFirstnames'     => 'first_name',
                            'BillingSurname'      => 'last_name',
                            'BillingAddress1' => 'address1',
                            'BillingCity'           => 'city',
                            'BillingPostCode'    => 'zip',
                            'CustomerEMail'          => 'email' );
        */
        // add name and address if available, CRM-3130
        $otherVars = array( 'first_name'     => 'BillingFirstnames',
                            'last_name'      => 'BillingSurname',
                            'street_address' => 'BillingAddress1',
                            'city'           => 'BillingCity',
                            'state_province' => 'state',
                            'postal_code'    => 'BillingPostCode',
                            'email'          => 'CustomerEMail' );

        foreach ( array_keys( $params ) as $p ) {
            // get the base name without the location type suffixed to it
            $parts = split( '-', $p );
            $name  = count( $parts ) > 1 ? $parts[0] : $p;
            if ( isset( $otherVars[$name] ) ) {
                $value = $params[$p];
                if ( $value ) {
                    if ( $name == 'state_province' ) {
                        $stateName = CRM_Core_PseudoConstant::stateProvinceAbbreviation( $value );
                        $value     = $stateName;
                    }
                    // ensure value is not an array
                    // CRM-4174
                    if ( ! is_array( $value ) ) {
                        $protxParams[$otherVars[$name]] = $value;
                    }
                }
            }
        }

        // add name and address if available, CRM-3130
        $otherVars2 = array( 'first_name'     => 'DeliveryFirstnames',
                            'last_name'      => 'DeliverySurname',
                            'street_address' => 'DeliveryAddress1',
                            'city'           => 'DeliveryCity',
                            'postal_code'    => 'DeliveryPostCode');

        foreach ( array_keys( $params ) as $p ) {
            // get the base name without the location type suffixed to it
            $parts = split( '-', $p );
            $name  = count( $parts ) > 1 ? $parts[0] : $p;
            if ( isset( $otherVars2[$name] ) ) {
                $value = $params[$p];
                if ( $value ) {
                    if ( $name == 'state_province' ) {
                        $stateName = CRM_Core_PseudoConstant::stateProvinceAbbreviation( $value );
                        $value     = $stateName;
                    }
                    // ensure value is not an array
                    // CRM-4174
                    if ( ! is_array( $value ) ) {
                        $protxParams[$otherVars2[$name]] = $value;
                    }
                }
            }
        }

        // if recurring donations, add a few more items
        if ( ! empty( $params['is_recur'] ) ) {
            if ( $params['contributionRecurID'] ) {
                $notifyURL .= "&contributionRecurID={$params['contributionRecurID']}&contributionPageID={$params['contributionPageID']}";
                $protxParams['notify_url'] = $notifyURL;
            } else {
                CRM_Core_Error::fatal( ts( 'Recurring contribution, but no database id' ) );
            }

            $protxParams +=
                array( 'cmd'                => '_xclick-subscriptions',
                       'a3'                 => $params['amount'],
                       'p3'                 => $params['frequency_interval'],
                       't3'                 => ucfirst( substr( $params['frequency_unit'], 0, 1 ) ),
                       'src'                => 1,
                       'sra'                => 1,
                       'srt'                => ( $params['installments'] > 0 ) ? $params['installments'] : null,
                       'no_note'            => 1,
                       'modify'             => 0,
                       );
        } else {
            $protxParams +=
                array( 'amount'             => $params['amount'],
                       );
        }

        $uri = '';
        foreach ( $protxParams as $key => $value ) {
            if ( $value === null ) {
                continue;
            }

            $value = urlencode( $value );
            if ( $key == 'return' ||
                 $key == 'cancel_return' ||
                 $key == 'notify_url' ) {
                $value = str_replace( '%2F', '/', $value );
            }
            $uri .= "&{$key}={$value}";
        }

        $uri = substr( $uri, 1 );
        $url = $this->_paymentProcessor['url_site'];
        $sub = empty( $params['is_recur'] ) ? 'cgi-bin/webscr' : 'subscriptions';
        $paypalURL = "{$url}{$sub}?$uri";

        //CRM_Utils_System::redirect( $paypalURL );

        //$strPost = 'https://test.sagepay.com/Simulator/VSPServerGateway.asp?Service=VendorRegisterTx&VPSProtocol=2.23&TxType=PAYMENT&Vendor=nfpservices&VendorTxCode=nfpservices-090902171847-577538301&Amount=43.38&Currency=GBP&Description=The+best+DVDs+from+nfpservices&NotificationURL=https://secure.millertech.co.uk:8092/SagePayServerKit/notificationPage.php&BillingFirstnames=Parvez&BillingSurname=Saleh&BillingAddress1=102&BillingCity=London&BillingPostCode=E18 1LZ&BillingCountry=GB&DeliveryFirstnames=Parvez&DeliverySurname=Saleh&DeliveryAddress1=102&DeliveryCity=London&DeliveryPostCode=E18 1LZ&DeliveryCountry=GB&CustomerEMail=&Basket=3%3AShaolin+Soccer%3A2%3A8.47%3A1.48%3A9.95%3A19.90%3ABatman+-+The+Dark+Knight%3A2%3A9.35%3A1.64%3A10.99%3A21.98%3ADelivery%3A1%3A1.50%3A---%3A1.50%3A1.50&AllowGiftAid=0&ApplyAVSCV2=0&Apply3DSecure=0&Profile=NORMAL)';
        //$strPost = 'VPSProtocol=2.23&TxType=PAYMENT&Vendor=nfpservices&VendorTxCode='.$params['invoiceID'].'&Amount=34.47&Currency=GBP&Description=The+best+DVDs+from+nfpservices&NotificationURL='.$notifyURL.'&BillingFirstnames=parvez&BillingSurname=saleh&BillingAddress1=102 Cadogan Gardens&BillingCity=Lonfon&BillingPostCode=jfkjb&BillingCountry=GB&DeliveryFirstnames=parvez&DeliverySurname=saleh&DeliveryAddress1=102 Cadogan Gardens&DeliveryCity=Lonfon&DeliveryPostCode=jfkjb&DeliveryCountry=GB&CustomerEMail=&Basket=2%3ABatman+-+The+Dark+Knight%3A3%3A9.35%3A1.64%3A10.99%3A32.97%3ADelivery%3A1%3A1.50%3A---%3A1.50%3A1.50&AllowGiftAid=0&ApplyAVSCV2=0&Apply3DSecure=0&Profile=NORMAL';
        //$strPurchaseURL = 'https://test.sagepay.com/simulator/VSPServerGateway.asp?Service=VendorRegisterTx';
        $strPurchaseURL = $url;
        $strPost = $uri;

        CRM_Core_Error::debug_log_message('strPurchaseURL'.$strPurchaseURL);
        CRM_Core_Error::debug_log_message('strPost'.$strPost);

        $arrResponse = CRM_Core_Payment_ProtX::requestPost($strPurchaseURL, $strPost);

        /* Analyse the response from Sage Pay Server to check that everything is okay
        ** Registration results come back in the Status and StatusDetail fields */
        $strStatus=$arrResponse["Status"];
        $strStatusDetail=$arrResponse["StatusDetail"];
        //insert into parvez values ( $arrResponse["VPSTxId"].':'.$arrResponse["SecurityKey"].':'.$arrResponse["NextURL"] );
        CRM_Core_Error::debug_log_message('VPSTxId'.$arrResponse["VPSTxId"]);
        CRM_Core_Error::debug_log_message('SecurityKey'.$arrResponse["SecurityKey"]);
        CRM_Core_Error::debug_log_message('NextURL'.$arrResponse["NextURL"]);
        CRM_Core_Error::debug_log_message('Status'.$arrResponse["Status"]);
        CRM_Core_Error::debug_log_message('StatusDetail'.$arrResponse["StatusDetail"]);
        CRM_Utils_System::redirect( $arrResponse["NextURL"] );
    }

    /**
     * hash_call: Function to perform the API call to PayPal using API signature
     * @methodName is name of API  method.
     * @nvpStr is nvp string.
     * returns an associtive array containing the response from the server.
     */
    function invokeAPI( $args, $url = null ) {

        if ( $url === null ) {
            if ( empty( $this->_paymentProcessor['url_api'] ) ) {
                CRM_Core_Error::fatal( ts( 'Please set the API URL. Please refer to the documentation for more details' ) );
            }

            $url = $this->_paymentProcessor['url_api'] . 'nvp';
        }

        if ( !function_exists('curl_init') ) {
            CRM_Core_Error::fatal("curl functions NOT available.");
        }

        //setting the curl parameters.
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url );
        curl_setopt($ch, CURLOPT_VERBOSE, 1);

        //turning off the server and peer verification(TrustManager Concept).
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);

        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_POST, 1);

        $p = array( );
        foreach ( $args as $n => $v ) {
            $p[] = "$n=" . urlencode( $v );
        }

        //NVPRequest for submitting to server
        $nvpreq = implode( '&', $p );

        //setting the nvpreq as POST FIELD to curl
        curl_setopt($ch, CURLOPT_POSTFIELDS, $nvpreq);

        //getting response from server
        $response = curl_exec( $ch );

        //converting NVPResponse to an Associative Array
        $result = self::deformat( $response );

        if ( curl_errno( $ch ) ) {
            $e =& CRM_Core_Error::singleton( );
            $e->push( curl_errno( $ch ),
                      0, null,
                      curl_error( $ch ) );
            return $e;
        } else {
      curl_close($ch);
        }

        if ( strtolower( $result['ack'] ) != 'success' &&
             strtolower( $result['ack'] ) != 'successwithwarning' ) {
            $e =& CRM_Core_Error::singleton( );
            $e->push( $result['l_errorcode0'],
                      0, null,
                      "{$result['l_shortmessage0']} {$result['l_longmessage0']}" );
            return $e;
        }

        return $result;
    }

    /** This function will take NVPString and convert it to an Associative Array and it will decode the response.
     * It is usefull to search for a particular key and displaying arrays.
     * @nvpstr is NVPString.
     * @nvpArray is Associative Array.
     */

    static function deformat( $str )
    {
        $result = array();

        while ( strlen( $str ) ) {
            // postion of key
            $keyPos = strpos( $str, '=' );

            // position of value
            $valPos = strpos( $str, '&' ) ? strpos( $str, '&' ): strlen( $str );

            /*getting the Key and Value values and storing in a Associative Array*/
            $key = substr( $str, 0, $keyPos );
            $val = substr( $str, $keyPos + 1, $valPos - $keyPos - 1 );

            //decoding the respose
            $result[ strtolower( urldecode( $key ) ) ] = urldecode( $val );
            $str = substr( $str, $valPos + 1, strlen( $str ) );
        }

        return $result;
    }

}


